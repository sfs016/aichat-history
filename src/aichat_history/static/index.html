<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aichat-history</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark" disabled />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <style>
    [v-cloak] { display: none; }

    /* ── Animations ───────────────────────────────── */
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulseRing {
      0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.5); }
      70% { box-shadow: 0 0 0 4px rgba(59,130,246,0); }
      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Message entrance animation */
    .msg-animate {
      animation: fadeSlideUp 0.25s ease-out both;
    }

    /* Pulse ring for nav-jump target */
    .msg-pulse {
      animation: pulseRing 0.8s ease-out;
    }

    /* Global transition base — keep subtle */
    * { -webkit-tap-highlight-color: transparent; }

    /* Markdown content styles */
    .msg-content pre { margin: 0.5rem 0; border-radius: 0.375rem; overflow-x: auto; position: relative; }
    .msg-content pre code { display: block; padding: 1rem; font-size: 0.85rem; line-height: 1.5; }
    .msg-content code:not(pre code) { font-size: 0.85rem; padding: 0.15rem 0.4rem; border-radius: 0.25rem; background: rgba(0,0,0,0.06); }
    .dark .msg-content code:not(pre code) { background: rgba(255,255,255,0.1); }
    .msg-content p { margin: 0.4rem 0; line-height: 1.6; }
    .msg-content ul, .msg-content ol { margin: 0.4rem 0; padding-left: 1.5rem; }
    .msg-content ul { list-style-type: disc; }
    .msg-content ol { list-style-type: decimal; }
    .msg-content li { margin: 0.2rem 0; }
    .msg-content h1 { font-size: 1.25rem; font-weight: 700; margin: 0.8rem 0 0.3rem; }
    .msg-content h2 { font-size: 1.1rem; font-weight: 600; margin: 0.6rem 0 0.3rem; }
    .msg-content h3 { font-size: 1rem; font-weight: 600; margin: 0.5rem 0 0.2rem; }
    .msg-content blockquote { border-left: 3px solid #6b7280; padding-left: 0.75rem; margin: 0.4rem 0; opacity: 0.85; }
    .msg-content a { color: #3b82f6; text-decoration: underline; }
    .msg-content table { border-collapse: collapse; margin: 0.5rem 0; width: 100%; }
    .msg-content th, .msg-content td { border: 1px solid #d1d5db; padding: 0.3rem 0.6rem; text-align: left; font-size: 0.85rem; }
    .dark .msg-content th, .dark .msg-content td { border-color: #4b5563; }
    .msg-content th { background: rgba(0,0,0,0.04); font-weight: 600; }
    .dark .msg-content th { background: rgba(255,255,255,0.05); }
    .msg-content hr { margin: 0.5rem 0; border-color: #e5e7eb; }
    .dark .msg-content hr { border-color: #374151; }

    /* Copy button on code blocks */
    .code-wrapper { position: relative; }
    .copy-btn {
      position: absolute; top: 0.4rem; right: 0.4rem;
      padding: 0.2rem 0.5rem; font-size: 0.7rem;
      background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 0.25rem; cursor: pointer; color: #9ca3af;
      opacity: 0; transition: all 0.2s ease;
    }
    .code-wrapper:hover .copy-btn { opacity: 1; }
    .copy-btn:hover { background: rgba(255,255,255,0.25); color: #e5e7eb; transform: scale(1.05); }
    .copy-btn:active { transform: scale(0.95); }
    .copy-btn.copied { color: #34d399; border-color: #34d399; }

    /* Collapsible */
    .collapsible-header { cursor: pointer; user-select: none; transition: opacity 0.15s ease; }
    .collapsible-header:hover { opacity: 0.75; }
    .collapsible-body { overflow: hidden; transition: max-height 0.3s ease; }

    /* Session list items */
    .session-item {
      transition: all 0.15s ease;
      border-left: 2px solid transparent;
    }
    .session-item:hover { transform: translateX(2px); }
    .session-item:active { transform: translateX(1px); }
    .session-item.selected {
      border-left-color: #3b82f6;
      background: rgb(239 246 255);
    }
    .dark .session-item.selected { background: rgba(30,58,138,0.2); }

    /* Buttons with press effect */
    .btn-interact { transition: all 0.15s ease; }
    .btn-interact:hover { transform: translateY(-1px); }
    .btn-interact:active { transform: translateY(0) scale(0.98); }

    /* Message navigation bar */
    .msg-nav {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .msg-nav-btn {
      padding: 0.25rem 0.5rem; border-radius: 0.375rem;
      font-size: 0.75rem; font-weight: 500;
      transition: all 0.2s ease; cursor: pointer;
      border: 1px solid transparent;
    }
    .msg-nav-btn:hover:not(:disabled) {
      background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.3);
      transform: translateY(-1px);
    }
    .msg-nav-btn:active:not(:disabled) { transform: translateY(0) scale(0.97); }
    .msg-nav-btn:disabled { opacity: 0.3; cursor: default; }
    .msg-nav-btn.active { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); color: #3b82f6; }

    /* Long content collapse */
    .content-collapsed {
      max-height: 300px; overflow: hidden; position: relative;
      transition: max-height 0.3s ease;
    }
    .content-collapsed::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0;
      height: 60px;
      background: linear-gradient(transparent, var(--fade-color, white));
      pointer-events: none;
    }
    .dark .content-collapsed::after { --fade-color: #1f2937; }
    .content-collapsed-white::after { --fade-color: white; }
    .dark .content-collapsed-white::after { --fade-color: #1f2937; }
    .content-collapsed-blue::after { --fade-color: #eff6ff; }
    .dark .content-collapsed-blue::after { --fade-color: rgba(30,58,138,0.2); }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

    /* Source badge labels */
    .source-label-cursor { display: inline; }
    .source-label-cursor::after { content: 'cursor'; }
    .source-label-claude_code { display: inline; }
    .source-label-claude_code::after { content: 'claude'; }
    .source-label-opencode { display: inline; }
    .source-label-opencode::after { content: 'opencode'; }
  </style>
</head>
<body class="h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
<div id="app" v-cloak class="h-full flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex-shrink-0">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
      <h1 class="text-lg font-bold tracking-tight">aichat-history</h1>
      <span class="text-xs text-gray-400 hidden sm:inline">unified AI chat viewer</span>
    </div>
    <div class="flex items-center gap-2">
      <span v-if="sessions.length" class="text-xs text-gray-400">{{ sessions.length }} sessions</span>
      <button @click="toggleDark" class="btn-interact p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-sm" :title="dark ? 'Light mode' : 'Dark mode'">
        <template v-if="dark"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg></template>
        <template v-else><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></template>
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-80 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 flex flex-col bg-gray-50 dark:bg-gray-800 overflow-hidden">
      <!-- Source tabs -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 text-sm">
        <button v-for="tab in sourceTabs" :key="tab.value"
          @click="sourceFilter = tab.value; loadSessions()"
          :class="['flex-1 py-2 px-1 text-center whitespace-nowrap text-xs sm:text-sm transition-all duration-200', sourceFilter === tab.value ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 font-medium' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700/50']">
          {{ tab.label }}
        </button>
      </div>

      <!-- Search -->
      <div class="p-2">
        <div class="relative">
          <svg class="absolute left-2.5 top-2 w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input v-model="searchQuery" @input="debounceSearch" type="text" placeholder="Search sessions..."
            class="w-full pl-8 pr-3 py-1.5 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:border-blue-400 transition-all duration-200" />
        </div>
      </div>

      <!-- Sort + filter -->
      <div class="px-2 pb-2 flex gap-2">
        <select v-model="sortBy" @change="loadSessions()"
          class="flex-1 text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
          <option value="newest">Newest first</option>
          <option value="messages">Most messages</option>
          <option value="project">Project name</option>
        </select>
        <select v-model="projectFilter" @change="loadSessions()"
          class="flex-1 text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 truncate">
          <option value="">All projects</option>
          <option v-for="p in projects" :key="p" :value="p">{{ shortPath(p) }}</option>
        </select>
      </div>

      <!-- Session list -->
      <div class="flex-1 overflow-y-auto">
        <div v-if="loading" class="p-8 text-center">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-blue-500"></div>
          <p class="mt-2 text-sm text-gray-500">Loading sessions...</p>
        </div>
        <div v-else-if="sessions.length === 0" class="p-6 text-center text-sm text-gray-500">
          <template v-if="sources.length === 0">
            <svg class="w-10 h-10 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <p class="font-medium">No AI IDE data found</p>
            <p class="text-xs mt-1 text-gray-400">Checked Cursor, Claude Code, and OpenCode storage paths.</p>
          </template>
          <template v-else>
            <p>No sessions match your filters.</p>
          </template>
        </div>
        <button v-for="(s, sIdx) in sessions" :key="s.id"
          @click="selectSession(s)"
          :class="['session-item w-full text-left px-3 py-2.5 border-b border-gray-100 dark:border-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700/50', selectedSession?.id === s.id ? 'selected' : '']"
          :style="{ animationDelay: Math.min(sIdx * 20, 400) + 'ms' }">
          <div class="flex items-center gap-1.5 mb-0.5">
            <span :class="sourceBadgeClass(s.source)" class="text-[10px] px-1.5 py-0.5 rounded font-medium uppercase tracking-wide">{{ sourceLabel(s.source) }}</span>
            <span class="text-xs text-gray-400 ml-auto">{{ s.message_count }} msgs</span>
          </div>
          <div class="text-sm font-medium truncate leading-snug">{{ s.title }}</div>
          <div class="flex items-center gap-2 mt-0.5">
            <span class="text-xs text-gray-500 dark:text-gray-400 truncate flex-1">{{ shortPath(s.project_path) }}</span>
            <span v-if="s.updated" class="text-[10px] text-gray-400 whitespace-nowrap">{{ formatDate(s.updated) }}</span>
          </div>
        </button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50/50 dark:bg-gray-900">
      <template v-if="selectedSession">
        <!-- Session header -->
        <div class="px-5 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0">
          <div class="flex items-center gap-2 mb-1">
            <span :class="sourceBadgeClass(selectedSession.source)" class="text-xs px-2 py-0.5 rounded font-medium uppercase tracking-wide">{{ sourceLabel(selectedSession.source) }}</span>
            <h2 class="text-base font-semibold truncate">{{ selectedSession.title }}</h2>
          </div>
          <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <span v-if="selectedSession.project_path" class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
              {{ selectedSession.project_path }}
            </span>
            <span v-if="selectedSession.created" class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              {{ formatDate(selectedSession.created) }}
            </span>
            <span>{{ messages.length || selectedSession.message_count }} messages</span>
          </div>
          <div class="mt-2 flex gap-2">
            <a :href="'/api/export/' + encodeURIComponent(selectedSession.id) + '?format=md'"
              class="btn-interact inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Export MD
            </a>
            <a :href="'/api/export/' + encodeURIComponent(selectedSession.id) + '?format=json'"
              class="btn-interact inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Export JSON
            </a>
          </div>
        </div>

        <!-- Message navigation bar -->
        <div v-if="!messagesLoading && messages.length > 0" class="msg-nav flex items-center gap-2 px-5 py-2 border-b border-gray-200 dark:border-gray-700 bg-white/80 dark:bg-gray-800/80 flex-shrink-0">
          <span class="text-xs text-gray-500 dark:text-gray-400 mr-1">Navigate:</span>
          <button @click="jumpToPrev('user')" :disabled="!canJump('user', -1)" class="msg-nav-btn" title="Previous user message">
            <svg class="w-3 h-3 inline -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            User
          </button>
          <button @click="jumpToNext('user')" :disabled="!canJump('user', 1)" class="msg-nav-btn" title="Next user message">
            User
            <svg class="w-3 h-3 inline -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </button>
          <span class="text-gray-300 dark:text-gray-600">|</span>
          <button @click="jumpToPrev('assistant')" :disabled="!canJump('assistant', -1)" class="msg-nav-btn" title="Previous agent response">
            <svg class="w-3 h-3 inline -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Agent
          </button>
          <button @click="jumpToNext('assistant')" :disabled="!canJump('assistant', 1)" class="msg-nav-btn" title="Next agent response">
            Agent
            <svg class="w-3 h-3 inline -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </button>
          <span class="ml-auto text-[11px] text-gray-400">
            {{ turnSummary }}
          </span>
          <button v-if="hasCollapsibleAssistant" @click="toggleAllAssistant()" class="msg-nav-btn text-[11px]" :title="allAssistantCollapsed ? 'Expand all agent responses' : 'Collapse all agent responses'">
            {{ allAssistantCollapsed ? 'Expand All' : 'Collapse All' }}
          </button>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-3" ref="messagesContainer">
          <div v-if="messagesLoading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-blue-500"></div>
            <p class="mt-2 text-sm text-gray-500">Loading messages...</p>
          </div>
          <template v-else>
            <div v-for="(msg, idx) in displayedMessages" :key="idx"
              :ref="el => setMsgRef(el, idx)"
              :class="[messageClass(msg), 'msg-animate']"
              :style="{ animationDelay: Math.min(idx * 30, 600) + 'ms' }">
              <!-- Collapsible: tool, thinking, diff -->
              <template v-if="isCollapsible(msg)">
                <div class="collapsible-header flex items-center gap-2 text-sm" @click="toggleCollapse(idx)">
                  <span>{{ collapseIcon(msg) }}</span>
                  <span class="font-medium truncate">{{ collapseSummary(msg) }}</span>
                  <svg :class="['w-3 h-3 ml-auto text-gray-400 flex-shrink-0 transition-transform duration-200', collapsed[idx] ? '' : 'rotate-90']" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
                <div v-show="!collapsed[idx]" class="mt-2 msg-content text-sm" v-html="renderMarkdown(msg.content)"></div>
              </template>
              <!-- Regular message (user or assistant) -->
              <template v-else>
                <div class="flex items-center gap-2 mb-1.5">
                  <span class="text-xs font-semibold uppercase tracking-wide" :class="roleColor(msg.role)">{{ msg.role }}</span>
                  <span v-if="msg.timestamp" class="text-[11px] text-gray-400">{{ formatTime(msg.timestamp) }}</span>
                  <!-- Collapse toggle for long assistant messages -->
                  <button v-if="msg.role === 'assistant' && isLongContent(msg.content)"
                    @click="toggleContentCollapse(idx)"
                    class="btn-interact ml-auto text-[11px] px-2 py-0.5 rounded border border-gray-200 dark:border-gray-600 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700">
                    {{ contentCollapsed[idx] ? 'Show full' : 'Collapse' }}
                  </button>
                </div>
                <div :class="['msg-content text-sm leading-relaxed', contentCollapsed[idx] ? 'content-collapsed' + (msg.role === 'user' ? ' content-collapsed-blue' : ' content-collapsed-white') : '']"
                  v-html="renderMarkdown(msg.content)"></div>
                <button v-if="contentCollapsed[idx]"
                  @click="toggleContentCollapse(idx)"
                  class="btn-interact mt-2 text-xs text-blue-500 hover:text-blue-600 dark:text-blue-400 font-medium">
                  Show full response
                </button>
              </template>
            </div>
            <div v-if="messages.length > displayedMessages.length" class="text-center py-4 msg-animate" style="animation-delay: 0.4s">
              <button @click="loadMoreMessages"
                class="btn-interact text-sm px-5 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 shadow-sm">
                Load more ({{ messages.length - displayedMessages.length }} remaining)
              </button>
            </div>
          </template>
        </div>
      </template>

      <!-- Empty state -->
      <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-400 gap-3 msg-animate">
        <svg class="w-16 h-16 text-gray-200 dark:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        <p class="text-sm">Select a session to view chat history</p>
        <p class="text-xs text-gray-300 dark:text-gray-600">Browse conversations from Cursor, Claude Code, or OpenCode</p>
      </div>
    </main>
  </div>
</div>

<script>
const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

createApp({
  setup() {
    const dark = ref(window.matchMedia('(prefers-color-scheme: dark)').matches);
    const sources = ref([]);
    const sessions = ref([]);
    const projects = ref([]);
    const selectedSession = ref(null);
    const messages = ref([]);
    const loading = ref(true);
    const messagesLoading = ref(false);
    const sourceFilter = ref('');
    const searchQuery = ref('');
    const sortBy = ref('messages');
    const projectFilter = ref('');
    const collapsed = ref({});
    const contentCollapsed = ref({});
    const messageLimit = ref(50);
    const messagesContainer = ref(null);
    const msgRefs = ref({});
    const currentNavIndex = ref({user: -1, assistant: -1});

    let searchTimeout = null;

    const displayedMessages = computed(() => messages.value.slice(0, messageLimit.value));

    const sourceTabs = computed(() => {
      const tabs = [{ label: 'All', value: '' }];
      for (const s of sources.value) {
        const labels = { cursor: 'Cursor', claude_code: 'Claude Code', opencode: 'OpenCode' };
        tabs.push({ label: labels[s] || s, value: s });
      }
      return tabs;
    });

    function toggleDark() {
      dark.value = !dark.value;
      document.documentElement.classList.toggle('dark', dark.value);
      document.getElementById('hljs-dark').disabled = !dark.value;
      document.getElementById('hljs-light').disabled = dark.value;
      localStorage.setItem('aichat-dark', dark.value ? '1' : '0');
    }

    async function loadSources() {
      try {
        const resp = await fetch('/api/sources');
        sources.value = await resp.json();
      } catch (e) { console.error('Failed to load sources:', e); }
    }

    async function loadSessions() {
      loading.value = true;
      try {
        const params = new URLSearchParams();
        if (sourceFilter.value) params.set('source', sourceFilter.value);
        if (searchQuery.value) params.set('search', searchQuery.value);
        if (sortBy.value) params.set('sort', sortBy.value);
        if (projectFilter.value) params.set('project', projectFilter.value);
        const resp = await fetch('/api/sessions?' + params);
        const data = await resp.json();
        sessions.value = data.sessions;
        const allProjects = new Set(data.sessions.map(s => s.project_path).filter(Boolean));
        projects.value = [...allProjects].sort();
      } catch (e) { console.error('Failed to load sessions:', e); }
      loading.value = false;
    }

    async function selectSession(session) {
      selectedSession.value = session;
      messagesLoading.value = true;
      messageLimit.value = 50;
      collapsed.value = {};
      contentCollapsed.value = {};
      msgRefs.value = {};
      currentNavIndex.value = {user: 0, assistant: 0};
      try {
        const resp = await fetch('/api/session/' + encodeURIComponent(session.id));
        const data = await resp.json();
        messages.value = data.messages;
        data.messages.forEach((msg, idx) => {
          if (isCollapsible(msg)) collapsed.value[idx] = true;
          // Auto-collapse long assistant messages
          if (msg.role === 'assistant' && isLongContent(msg.content)) {
            contentCollapsed.value[idx] = true;
          }
        });
      } catch (e) { console.error('Failed to load messages:', e); }
      messagesLoading.value = false;
      await nextTick();
      if (messagesContainer.value) messagesContainer.value.scrollTop = 0;
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => loadSessions(), 300);
    }

    function loadMoreMessages() { messageLimit.value += 50; }

    // ── Message navigation ──────────────────────────────────
    function setMsgRef(el, idx) { if (el) msgRefs.value[idx] = el; }

    function getMsgIndices(role) {
      const indices = [];
      const msgs = displayedMessages.value;
      for (let i = 0; i < msgs.length; i++) {
        if (msgs[i].role === role) indices.push(i);
      }
      return indices;
    }

    function canJump(role, direction) {
      const indices = getMsgIndices(role);
      if (indices.length === 0) return false;
      const curr = currentNavIndex.value[role];
      if (direction > 0) return curr < indices.length - 1;
      if (direction < 0) return curr > 0;
      return false;
    }

    function jumpToNext(role) {
      const indices = getMsgIndices(role);
      if (indices.length === 0) return;
      let next = currentNavIndex.value[role] + 1;
      if (next >= indices.length) return;
      currentNavIndex.value[role] = next;
      scrollToMessage(indices[next]);
    }

    function jumpToPrev(role) {
      const indices = getMsgIndices(role);
      if (indices.length === 0) return;
      let prev = currentNavIndex.value[role] - 1;
      if (prev < 0) return;
      currentNavIndex.value[role] = prev;
      scrollToMessage(indices[prev]);
    }

    function scrollToMessage(idx) {
      const el = msgRefs.value[idx];
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Pulse highlight animation
        el.classList.remove('msg-pulse');
        void el.offsetWidth; // trigger reflow to restart animation
        el.classList.add('msg-pulse');
        el.addEventListener('animationend', () => el.classList.remove('msg-pulse'), { once: true });
      }
    }

    const turnSummary = computed(() => {
      const userCount = getMsgIndices('user').length;
      const asstCount = getMsgIndices('assistant').length;
      return `${userCount} user, ${asstCount} agent msgs`;
    });

    // ── Long content collapse ───────────────────────────────
    const LONG_CONTENT_THRESHOLD = 800; // characters

    function isLongContent(content) {
      return content && content.length > LONG_CONTENT_THRESHOLD;
    }

    function toggleContentCollapse(idx) {
      contentCollapsed.value[idx] = !contentCollapsed.value[idx];
    }

    const hasCollapsibleAssistant = computed(() => {
      return displayedMessages.value.some(m => m.role === 'assistant' && isLongContent(m.content));
    });

    const allAssistantCollapsed = computed(() => {
      const msgs = displayedMessages.value;
      let anyLong = false;
      for (let i = 0; i < msgs.length; i++) {
        if (msgs[i].role === 'assistant' && isLongContent(msgs[i].content)) {
          anyLong = true;
          if (!contentCollapsed.value[i]) return false;
        }
      }
      return anyLong;
    });

    function toggleAllAssistant() {
      const shouldCollapse = !allAssistantCollapsed.value;
      const msgs = displayedMessages.value;
      for (let i = 0; i < msgs.length; i++) {
        if (msgs[i].role === 'assistant' && isLongContent(msgs[i].content)) {
          contentCollapsed.value[i] = shouldCollapse;
        }
      }
    }

    function isCollapsible(msg) {
      return ['tool', 'thinking'].includes(msg.role) ||
             ['tool_call', 'tool_result', 'diff', 'thinking'].includes(msg.message_type);
    }

    function toggleCollapse(idx) { collapsed.value[idx] = !collapsed.value[idx]; }

    function collapseIcon(msg) {
      if (msg.message_type === 'thinking' || msg.role === 'thinking') return '\uD83E\uDDE0';
      if (msg.message_type === 'diff') return '\u270F\uFE0F';
      return '\uD83D\uDD27';
    }

    function collapseSummary(msg) {
      if (msg.message_type === 'thinking' || msg.role === 'thinking') return 'Thinking...';
      if (msg.metadata?.tool_name) {
        let s = msg.metadata.tool_name;
        if (msg.metadata.file_path) s += ': ' + msg.metadata.file_path;
        return s;
      }
      if (msg.message_type === 'diff') return 'Edit' + (msg.metadata?.file_path ? ': ' + msg.metadata.file_path : '');
      const firstLine = (msg.content || '').split('\n')[0].slice(0, 80);
      return firstLine || 'Tool call';
    }

    function messageClass(msg) {
      const base = 'rounded-lg px-4 py-3 ';
      if (msg.role === 'user') return base + 'bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400';
      if (msg.role === 'error') return base + 'bg-red-50 dark:bg-red-900/20 border-l-4 border-red-400';
      if (msg.role === 'tool' || msg.message_type === 'tool_call' || msg.message_type === 'tool_result')
        return base + 'bg-gray-100/80 dark:bg-gray-800/60 ml-4 text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-gray-700';
      if (msg.role === 'thinking' || msg.message_type === 'thinking')
        return base + 'bg-purple-50 dark:bg-purple-900/20 ml-4 border border-purple-200 dark:border-purple-800';
      return base + 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm';
    }

    function roleColor(role) {
      const colors = {
        user: 'text-blue-600 dark:text-blue-400',
        assistant: 'text-emerald-600 dark:text-emerald-400',
        tool: 'text-gray-500',
        thinking: 'text-purple-600 dark:text-purple-400',
        error: 'text-red-600 dark:text-red-400',
        system: 'text-yellow-600 dark:text-yellow-400',
      };
      return colors[role] || 'text-gray-600';
    }

    function sourceBadgeClass(source) {
      const classes = {
        cursor: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300',
        claude_code: 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-300',
        opencode: 'bg-violet-100 text-violet-800 dark:bg-violet-900/40 dark:text-violet-300',
      };
      return classes[source] || 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300';
    }

    function sourceLabel(source) {
      const labels = { cursor: 'Cursor', claude_code: 'Claude', opencode: 'OpenCode' };
      return labels[source] || source;
    }

    function renderMarkdown(content) {
      if (!content) return '';
      try {
        return marked.parse(content, { breaks: true, gfm: true });
      } catch { return content; }
    }

    function formatDate(iso) {
      if (!iso) return '';
      try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }); }
      catch { return iso; }
    }

    function formatTime(iso) {
      if (!iso) return '';
      try { return new Date(iso).toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
      catch { return iso; }
    }

    function shortPath(p) {
      if (!p) return '';
      const parts = p.replace(/\\/g, '/').split('/');
      if (parts.length <= 3) return p;
      return '.../' + parts.slice(-2).join('/');
    }

    onMounted(async () => {
      // Restore dark mode preference
      const saved = localStorage.getItem('aichat-dark');
      if (saved !== null) dark.value = saved === '1';
      document.documentElement.classList.toggle('dark', dark.value);
      document.getElementById('hljs-dark').disabled = !dark.value;
      document.getElementById('hljs-light').disabled = dark.value;
      await loadSources();
      await loadSessions();
    });

    return {
      dark, sources, sessions, projects, selectedSession, messages,
      loading, messagesLoading, sourceFilter, searchQuery, sortBy,
      projectFilter, collapsed, contentCollapsed, displayedMessages, sourceTabs,
      messagesContainer, messageLimit, turnSummary,
      hasCollapsibleAssistant, allAssistantCollapsed,
      toggleDark, loadSessions, selectSession, debounceSearch,
      loadMoreMessages, isCollapsible, toggleCollapse, collapseIcon,
      collapseSummary, messageClass, roleColor, sourceBadgeClass,
      sourceLabel, renderMarkdown, formatDate, formatTime, shortPath,
      setMsgRef, canJump, jumpToNext, jumpToPrev, isLongContent,
      toggleContentCollapse, toggleAllAssistant,
    };
  }
}).mount('#app');

// Highlight code blocks and add copy buttons after Vue renders
const observer = new MutationObserver(() => {
  document.querySelectorAll('.msg-content pre code:not(.hljs)').forEach(el => {
    hljs.highlightElement(el);
  });
  // Add copy buttons to code blocks that don't have one
  document.querySelectorAll('.msg-content pre:not(.has-copy-btn)').forEach(pre => {
    pre.classList.add('has-copy-btn');
    const wrapper = document.createElement('div');
    wrapper.className = 'code-wrapper';
    pre.parentNode.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.addEventListener('click', () => {
      const code = pre.querySelector('code')?.textContent || pre.textContent;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
      });
    });
    wrapper.appendChild(btn);
  });
});
observer.observe(document.body, { childList: true, subtree: true });
</script>
</body>
</html>
