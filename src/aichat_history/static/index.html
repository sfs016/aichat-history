<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aichat-history</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark" disabled />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <style>
    [v-cloak] { display: none; }
    .msg-content pre { margin: 0.5rem 0; border-radius: 0.375rem; overflow-x: auto; }
    .msg-content pre code { display: block; padding: 1rem; font-size: 0.85rem; }
    .msg-content code { font-size: 0.85rem; padding: 0.1rem 0.3rem; border-radius: 0.25rem; }
    .msg-content p { margin: 0.4rem 0; }
    .msg-content ul, .msg-content ol { margin: 0.4rem 0; padding-left: 1.5rem; }
    .msg-content ul { list-style-type: disc; }
    .msg-content ol { list-style-type: decimal; }
    .msg-content h1, .msg-content h2, .msg-content h3 { font-weight: 600; margin: 0.6rem 0 0.3rem; }
    .msg-content blockquote { border-left: 3px solid #6b7280; padding-left: 0.75rem; margin: 0.4rem 0; opacity: 0.85; }
    .collapsible-header { cursor: pointer; user-select: none; }
    .collapsible-header:hover { opacity: 0.8; }
  </style>
</head>
<body class="h-full bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
<div id="app" v-cloak class="h-full flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex-shrink-0">
    <h1 class="text-lg font-bold tracking-tight">aichat-history</h1>
    <div class="flex items-center gap-3">
      <button @click="toggleDark" class="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-sm" :title="dark ? 'Light mode' : 'Dark mode'">
        {{ dark ? '\u2600\uFE0F' : '\uD83C\uDF19' }}
      </button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-80 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 flex flex-col bg-gray-50 dark:bg-gray-800 overflow-hidden">
      <!-- Source tabs -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 text-sm">
        <button v-for="tab in sourceTabs" :key="tab.value"
          @click="sourceFilter = tab.value; loadSessions()"
          :class="['flex-1 py-2 px-1 text-center transition-colors', sourceFilter === tab.value ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 font-medium' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-400']">
          {{ tab.label }}
        </button>
      </div>

      <!-- Search -->
      <div class="p-2">
        <input v-model="searchQuery" @input="debounceSearch" type="text" placeholder="Search sessions..."
          class="w-full px-3 py-1.5 text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500" />
      </div>

      <!-- Sort -->
      <div class="px-2 pb-2 flex gap-2">
        <select v-model="sortBy" @change="loadSessions()"
          class="flex-1 text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
          <option value="newest">Newest first</option>
          <option value="messages">Most messages</option>
          <option value="project">Project name</option>
        </select>
        <select v-model="projectFilter" @change="loadSessions()"
          class="flex-1 text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 truncate">
          <option value="">All projects</option>
          <option v-for="p in projects" :key="p" :value="p">{{ shortPath(p) }}</option>
        </select>
      </div>

      <!-- Session list -->
      <div class="flex-1 overflow-y-auto">
        <div v-if="loading" class="p-4 text-center text-sm text-gray-500">Loading...</div>
        <div v-else-if="sessions.length === 0" class="p-4 text-center text-sm text-gray-500">
          <template v-if="sources.length === 0">
            No AI IDE data found.<br />
            <span class="text-xs">Checked Cursor, Claude Code, and OpenCode storage paths.</span>
          </template>
          <template v-else>No sessions found.</template>
        </div>
        <button v-for="s in sessions" :key="s.id"
          @click="selectSession(s)"
          :class="['w-full text-left px-3 py-2 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors', selectedSession?.id === s.id ? 'bg-blue-50 dark:bg-gray-600' : '']">
          <div class="flex items-center gap-1.5 mb-0.5">
            <span :class="sourceBadgeClass(s.source)" class="text-[10px] px-1.5 py-0.5 rounded font-medium uppercase">{{ s.source }}</span>
            <span class="text-xs text-gray-400">{{ s.message_count }} msgs</span>
          </div>
          <div class="text-sm font-medium truncate">{{ s.title }}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ shortPath(s.project_path) }}</div>
          <div v-if="s.updated" class="text-xs text-gray-400">{{ formatDate(s.updated) }}</div>
        </button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <template v-if="selectedSession">
        <!-- Session header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0">
          <div class="flex items-center gap-2 mb-1">
            <span :class="sourceBadgeClass(selectedSession.source)" class="text-xs px-2 py-0.5 rounded font-medium uppercase">{{ selectedSession.source }}</span>
            <h2 class="text-base font-semibold truncate">{{ selectedSession.title }}</h2>
          </div>
          <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <span v-if="selectedSession.project_path">{{ selectedSession.project_path }}</span>
            <span v-if="selectedSession.created">{{ formatDate(selectedSession.created) }}</span>
            <span>{{ selectedSession.message_count }} messages</span>
          </div>
          <div class="mt-2 flex gap-2">
            <a :href="'/api/export/' + encodeURIComponent(selectedSession.id) + '?format=md'" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Export MD</a>
            <a :href="'/api/export/' + encodeURIComponent(selectedSession.id) + '?format=json'" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Export JSON</a>
          </div>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3" ref="messagesContainer">
          <div v-if="messagesLoading" class="text-center text-sm text-gray-500 py-8">Loading messages...</div>
          <template v-else>
            <div v-for="(msg, idx) in displayedMessages" :key="idx"
              :class="messageClass(msg)">
              <!-- Collapsible: tool, thinking, diff -->
              <template v-if="isCollapsible(msg)">
                <div class="collapsible-header flex items-center gap-2 text-sm" @click="toggleCollapse(idx)">
                  <span>{{ collapseIcon(msg) }}</span>
                  <span class="font-medium">{{ collapseSummary(msg) }}</span>
                  <span class="text-xs text-gray-400 ml-auto">{{ collapsed[idx] ? '\u25B6' : '\u25BC' }}</span>
                </div>
                <div v-show="!collapsed[idx]" class="mt-2 msg-content text-sm" v-html="renderMarkdown(msg.content)"></div>
              </template>
              <!-- Regular message -->
              <template v-else>
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs font-semibold uppercase" :class="roleColor(msg.role)">{{ msg.role }}</span>
                  <span v-if="msg.timestamp" class="text-xs text-gray-400">{{ formatTime(msg.timestamp) }}</span>
                </div>
                <div class="msg-content text-sm" v-html="renderMarkdown(msg.content)"></div>
              </template>
            </div>
            <div v-if="messages.length > displayedMessages.length" class="text-center py-3">
              <button @click="loadMoreMessages" class="text-sm px-4 py-1.5 rounded bg-blue-500 text-white hover:bg-blue-600">
                Load more ({{ messages.length - displayedMessages.length }} remaining)
              </button>
            </div>
          </template>
        </div>
      </template>

      <!-- Empty state -->
      <div v-else class="flex-1 flex items-center justify-center text-gray-400 text-sm">
        Select a session to view chat history
      </div>
    </main>
  </div>
</div>

<script>
const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

createApp({
  setup() {
    const dark = ref(window.matchMedia('(prefers-color-scheme: dark)').matches);
    const sources = ref([]);
    const sessions = ref([]);
    const projects = ref([]);
    const selectedSession = ref(null);
    const messages = ref([]);
    const loading = ref(true);
    const messagesLoading = ref(false);
    const sourceFilter = ref('');
    const searchQuery = ref('');
    const sortBy = ref('newest');
    const projectFilter = ref('');
    const collapsed = ref({});
    const messageLimit = ref(50);
    const messagesContainer = ref(null);

    let searchTimeout = null;

    const displayedMessages = computed(() => messages.value.slice(0, messageLimit.value));

    const sourceTabs = computed(() => {
      const tabs = [{ label: 'All', value: '' }];
      for (const s of sources.value) {
        const labels = { cursor: 'Cursor', claude_code: 'Claude Code', opencode: 'OpenCode' };
        tabs.push({ label: labels[s] || s, value: s });
      }
      return tabs;
    });

    function toggleDark() {
      dark.value = !dark.value;
      document.documentElement.classList.toggle('dark', dark.value);
      document.getElementById('hljs-dark').disabled = !dark.value;
      document.getElementById('hljs-light').disabled = dark.value;
    }

    async function loadSources() {
      try {
        const resp = await fetch('/api/sources');
        sources.value = await resp.json();
      } catch (e) { console.error('Failed to load sources:', e); }
    }

    async function loadSessions() {
      loading.value = true;
      try {
        const params = new URLSearchParams();
        if (sourceFilter.value) params.set('source', sourceFilter.value);
        if (searchQuery.value) params.set('search', searchQuery.value);
        if (sortBy.value) params.set('sort', sortBy.value);
        if (projectFilter.value) params.set('project', projectFilter.value);
        const resp = await fetch('/api/sessions?' + params);
        const data = await resp.json();
        sessions.value = data.sessions;
        // Collect unique projects
        const allProjects = new Set(data.sessions.map(s => s.project_path).filter(Boolean));
        projects.value = [...allProjects].sort();
      } catch (e) { console.error('Failed to load sessions:', e); }
      loading.value = false;
    }

    async function selectSession(session) {
      selectedSession.value = session;
      messagesLoading.value = true;
      messageLimit.value = 50;
      collapsed.value = {};
      try {
        const resp = await fetch('/api/session/' + encodeURIComponent(session.id));
        const data = await resp.json();
        messages.value = data.messages;
        // Auto-collapse tool/thinking messages
        data.messages.forEach((msg, idx) => {
          if (isCollapsible(msg)) collapsed.value[idx] = true;
        });
      } catch (e) { console.error('Failed to load messages:', e); }
      messagesLoading.value = false;
      await nextTick();
      if (messagesContainer.value) messagesContainer.value.scrollTop = 0;
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => loadSessions(), 300);
    }

    function loadMoreMessages() {
      messageLimit.value += 50;
    }

    function isCollapsible(msg) {
      return ['tool', 'thinking'].includes(msg.role) ||
             ['tool_call', 'tool_result', 'diff', 'thinking'].includes(msg.message_type);
    }

    function toggleCollapse(idx) {
      collapsed.value[idx] = !collapsed.value[idx];
    }

    function collapseIcon(msg) {
      if (msg.message_type === 'thinking' || msg.role === 'thinking') return '\uD83E\uDDE0';
      if (msg.message_type === 'diff') return '\u270F\uFE0F';
      return '\uD83D\uDD27';
    }

    function collapseSummary(msg) {
      if (msg.message_type === 'thinking' || msg.role === 'thinking') return 'Thinking...';
      if (msg.metadata?.tool_name) return msg.metadata.tool_name + (msg.metadata.file_path ? ': ' + msg.metadata.file_path : '');
      if (msg.message_type === 'diff') return 'Edit' + (msg.metadata?.file_path ? ': ' + msg.metadata.file_path : '');
      const firstLine = msg.content.split('\n')[0].slice(0, 80);
      return firstLine || 'Tool call';
    }

    function messageClass(msg) {
      const base = 'rounded-lg px-4 py-3 ';
      if (msg.role === 'user') return base + 'bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400';
      if (msg.role === 'error') return base + 'bg-red-50 dark:bg-red-900/20 border-l-4 border-red-400';
      if (msg.role === 'tool' || msg.message_type === 'tool_call' || msg.message_type === 'tool_result')
        return base + 'bg-gray-50 dark:bg-gray-800 ml-4 text-gray-600 dark:text-gray-400';
      if (msg.role === 'thinking' || msg.message_type === 'thinking')
        return base + 'bg-purple-50 dark:bg-purple-900/20 ml-4';
      return base + 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700';
    }

    function roleColor(role) {
      const colors = {
        user: 'text-blue-600 dark:text-blue-400',
        assistant: 'text-gray-700 dark:text-gray-300',
        tool: 'text-gray-500',
        thinking: 'text-purple-600 dark:text-purple-400',
        error: 'text-red-600 dark:text-red-400',
        system: 'text-yellow-600 dark:text-yellow-400',
      };
      return colors[role] || 'text-gray-600';
    }

    function sourceBadgeClass(source) {
      const classes = {
        cursor: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
        claude_code: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300',
        opencode: 'bg-violet-100 text-violet-700 dark:bg-violet-900 dark:text-violet-300',
      };
      return classes[source] || 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300';
    }

    function renderMarkdown(content) {
      if (!content) return '';
      try {
        const html = marked.parse(content, { breaks: true, gfm: true });
        return html;
      } catch { return content; }
    }

    function formatDate(iso) {
      if (!iso) return '';
      try {
        return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      } catch { return iso; }
    }

    function formatTime(iso) {
      if (!iso) return '';
      try {
        return new Date(iso).toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch { return iso; }
    }

    function shortPath(p) {
      if (!p) return '';
      const parts = p.replace(/\\/g, '/').split('/');
      if (parts.length <= 3) return p;
      return '.../' + parts.slice(-2).join('/');
    }

    onMounted(async () => {
      document.documentElement.classList.toggle('dark', dark.value);
      document.getElementById('hljs-dark').disabled = !dark.value;
      document.getElementById('hljs-light').disabled = dark.value;
      await loadSources();
      await loadSessions();
    });

    return {
      dark, sources, sessions, projects, selectedSession, messages,
      loading, messagesLoading, sourceFilter, searchQuery, sortBy,
      projectFilter, collapsed, displayedMessages, sourceTabs,
      messagesContainer, messageLimit,
      toggleDark, loadSessions, selectSession, debounceSearch,
      loadMoreMessages, isCollapsible, toggleCollapse, collapseIcon,
      collapseSummary, messageClass, roleColor, sourceBadgeClass,
      renderMarkdown, formatDate, formatTime, shortPath,
    };
  }
}).mount('#app');

// Highlight code blocks after Vue renders
const observer = new MutationObserver(() => {
  document.querySelectorAll('.msg-content pre code:not(.hljs)').forEach(el => {
    hljs.highlightElement(el);
  });
});
observer.observe(document.body, { childList: true, subtree: true });
</script>
</body>
</html>
